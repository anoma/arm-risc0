//! Compliance unit module containing the compliance proof and instance.

use crate::{
    compliance::ComplianceInstance,
    constants::COMPLIANCE_VK,
    error::ArmError,
    proving_system::{journal_to_instance, verify as verify_proof},
};
use k256::ProjectivePoint;
use risc0_zkvm::InnerReceipt;
use serde::{Deserialize, Serialize};

#[cfg(feature = "prove")]
use crate::{
    compliance::ComplianceWitness,
    constants::COMPLIANCE_PK,
    proving_system::{prove, ProofType},
};

/// A compliance unit consists of a compliance proof and its corresponding instance.
/// The vk is a constant in the compliance unit, so we don't place it here.
#[derive(Clone, Debug, Deserialize, Serialize, PartialEq, Eq)]
pub struct ComplianceUnit {
    /// The compliance proof (optional, would be absent when aggregation is enabled).
    pub proof: Option<Vec<u8>>,
    /// The serialized compliance instance.
    pub instance: Vec<u8>,
}

impl ComplianceUnit {
    /// Creates a new compliance unit by proving the given witness.
    /// Proving key and verifying key are constants, so we don't need to pass
    /// them as parameters. Instance is generated by proving.
    #[cfg(feature = "prove")]
    pub fn create(witness: &ComplianceWitness, proof_type: ProofType) -> Result<Self, ArmError> {
        let (proof, instance) = prove(COMPLIANCE_PK, witness, proof_type)?;
        Ok(ComplianceUnit {
            proof: Some(proof),
            instance,
        })
    }

    /// Verifies the compliance proof against the instance using the constant verifying key.
    pub fn verify(&self) -> Result<(), ArmError> {
        if let Some(proof) = &self.proof {
            verify_proof(&COMPLIANCE_VK, &self.instance, proof)
        } else {
            Err(ArmError::ProofVerificationFailed(
                "Missing compliance proof".into(),
            ))
        }
    }

    /// Obtains the delta from the compliance instance.
    pub fn delta(&self) -> Result<ProjectivePoint, ArmError> {
        self.get_instance()?.delta_projective()
    }

    /// Retrieves the compliance instance from the serialized instance data.
    pub fn get_instance(&self) -> Result<ComplianceInstance, ArmError> {
        journal_to_instance(&self.instance)
    }

    /// Retrieves the inner receipt from the compliance proof.
    pub fn get_inner_receipt(&self) -> Result<InnerReceipt, ArmError> {
        let inner: InnerReceipt = bincode::deserialize(
            self.proof
                .as_ref()
                .ok_or(ArmError::MissingField("Missing compliance proof"))?,
        )
        .map_err(|_| ArmError::InnerReceiptDeserializationError)?;
        Ok(inner)
    }
}
